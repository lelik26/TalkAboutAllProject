from telegram import Update
from telegram.ext import CallbackContext
from utils.logger import setup_logger
from services.talk_about_all import talk_with_assistant
import asyncio

logger = setup_logger(__name__)

async def talk_command(update: Update, _: CallbackContext) -> None:
    try:
        await update.message.reply_text("üëå–ú–æ–∂–µ–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã üí°–ù–∞–ø–∏—à–∏ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å üìç, –∏ —è –æ—Ç–≤–µ—á—É üí¨:")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ talk_command: {str(e)}")

async def talk_response(update: Update, context: CallbackContext) -> None:
    try:
        user_message = update.message.text

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç"
        await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å–ø–µ–ª –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è
        await asyncio.sleep(2)

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        response = await asyncio.to_thread(talk_with_assistant, user_message)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await update.message.reply_text(response)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {str(e)}")
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")